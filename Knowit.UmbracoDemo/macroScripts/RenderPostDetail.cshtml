@using System.Text
@using umbraco.MacroEngines
@inherits umbraco.MacroEngines.DynamicNodeContext
@*
This script displays the contents of a single blog post for AJAX purposes OR renders current post for display at page top
*@

@{
    var post = Model;
    bool ajax = false;

    if (!String.IsNullOrEmpty(Parameter.ajax))
    {
        ajax = bool.Parse(Parameter.ajax);
    }

    if (ajax) { HttpContext.Current.Response.AddHeader("X-AJAX-RESPONSE-TITLE", post.heading); }
    var writer = umbraco.BusinessLogic.User.GetUser(post.writerId);
}
@if (ajax)
{
    //Render post without wrapping div and heading/author
    @RenderPost(post, writer.Email)
}
else
{
    //Render post with wrapping div and heading/author
    <div class="current post Array" id="post-@post.Id">
        <h1><a href="@post.NiceUrl">@post.heading</a></h1>
        <p class="author">@post.CreateDate.ToString("dd.MM.yy") - <a href="" rel="author">@post.WriterName</a></p>
        @RenderPost(post, writer.Email)
    </div>
}

@helper RenderPost(dynamic post, string writerEmail)
{
    <p class="lead">@post.lead</p>
    <p class="body">@post.body</p>
    <div class="authorinfo">
        @DisplayGravatar(writerEmail)
        <p>This article is written by @post.WriterName and was published @post.CreateDate.ToString("dd.MM.yy")</p>
        <p></p>
        <br class="cf" />
    </div>
}
@helper DisplayGravatar(string emailAddress)
{
    var emailHash = FormsAuthentication.HashPasswordForStoringInConfigFile(emailAddress.Trim(), "MD5").ToLower();
    <img src="http://www.gravatar.com/avatar/@emailHash" alt="Gravatar" class='avatar avatar-60 photo' height='60' width='60' />
}
